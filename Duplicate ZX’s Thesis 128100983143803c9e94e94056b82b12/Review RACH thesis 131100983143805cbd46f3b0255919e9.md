# Review RACH thesis

<aside>

1. Review RACH thesisçš„ç›®çš„æ˜¯è¦äº†è§£PHYåœ¨æ”¶åˆ°RACHå¾Œçš„è™•ç†æ­¥é©Ÿï¼Œæ‰¾å‡ºå°æ‡‰çš„ç¨‹å¼ç¢¼ï¼Œæœ€çµ‚ç›®çš„æ˜¯è¦å»èªªæ˜é€ æˆpreamble detection errorçš„å¯èƒ½åŸå› 
é€éé€™å€‹æ©Ÿæœƒæ›´äº†è§£RACHçš„é‹ä½œ
    
    [ä¿®æ”¹å¾Œè«–æ–‡.pdf](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/%25E4%25BF%25AE%25E6%2594%25B9%25E5%25BE%258C%25E8%25AB%2596%25E6%2596%2587.pdf)
    

[https://www.sharetechnote.com/html/5G/5G_RACH.html](https://www.sharetechnote.com/html/5G/5G_RACH.html)

</aside>

**PRACH Detection**

- In function `L1_nr_prach_procedures()` line **154** there is a check to see if the estimated prach energy is above the threshold that is given in the gNB config file.
- Energy comparison after :
    1. correlation with all the required ZC sequences (multiplication in
    frequency-domain by conjugate ZC sequence) dictated by the PRACH configuration (NCS and limitations on number of preambles)
    2. inverse DFT and complex modulus of time-domain correlation
    3. identification of maxima in PRACH windows based on cyclic-delays
    If the maximum metric over all possible sequences and delays exceeds the threshold, we say that there is a candidate PRACH to be checked.

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image.png)

<aside>

```bash
#gNB log:
[0m[NR_PHY]   [RAPROC] 505.19 Initiating RA procedure with preamble 8, energy 56.4 dB (I0 204, thres 120), delay 0 start symbol 0 freq index 0
[0m[NR_MAC]   505.19 UE RA-RNTI 010b TC-RNTI 8a27: Activating RA process index 1
[0m[32m[NR_MAC]   UE 8a27: 506.7 Generating RA-Msg2 DCI, RA RNTI 0x10b, state 1, CoreSetType 0, RAPID 8
[0m[NR_MAC]   UE 8a27: Msg3 scheduled at 506.17 (506.7 k2 7 TDA 3)
```

> max_preamble_energy[0] = 564
> 

> prach_I0 = 204 (PRACH background noise level)
> 

> prach_threshold = 120
> 

---

[Zadoffâ€“Chu sequence](https://en.wikipedia.org/wiki/Zadoff%E2%80%93Chu_sequence)

</aside>

# PRACH èˆ‡ RACH èªªæ˜

## PRACH interface

### Preamble Sequence

UE æœƒç™¼é€ä¸€æ®µç”±ç³»çµ±åƒæ•¸(SIB1)èˆ‡éš¨æ©Ÿç‰¹å¾µå€¼ï¼ˆsignatureï¼‰æ‰€è¨ˆç®—çš„
**Preamble**ï¼Œæ­¤ **Preamble** å³ç”± **Zadoff-Chu** åºåˆ—ï¼ˆ**Zadoff-Chu Sequence, ZC Sequence**ï¼‰çµ„æˆ

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%201.png)

> åœ¨ time domain ä¸Šç”±å¾ªç’°å‰ç¶´ (Cyclic Prefix)ã€å‰å°
ç¢¼åºåˆ— (Preamble Sequence)ã€ä¿è­·å¸¶ï¼ˆGuard Periodï¼‰çµ„æˆä¸€çµ„ Preambleï¼Œè€Œ frequency
domain ä¸Šå‰‡å«æœ‰å¤šçµ„ Preambleã€‚
> 

> **å‚ç›´è»¸ä¸Šæœ‰å¤šå€‹é »åŸŸå‚³é€è³‡æº**ï¼Œæ­¤ç‚º 3GPP æ–¼ 5G NR å¯¦é«”å±¤è¦æ ¼æ–°è¨­è¨ˆã€‚éå»åœ¨ 4G LTE è¦æ ¼ä¸­ï¼Œ PRACH æ™‚é–“å€é–“ï¼ˆPRACH slotï¼‰ï¼Œåƒ…èƒ½æœ‰ä¸€**é »åŸŸ**è³‡æºå¯å‚³é€ PRACH è³‡è¨Šã€‚è€Œåœ¨ 5G ä¸­ï¼ŒgNB **å¯ä»¥ä¾è¨­å®šåœ¨PRACH Slot å…§æ–¼é »åŸŸä¸Šè¨­å®šå¤šå€‹ PRACH å‚³é€è³‡æº**ï¼ˆOccasionï¼‰ã€‚ç•¶è¨­å®šçš„æ•¸é‡è¶Šå¤šï¼ŒUE å¯ä»¥åœ¨ä¸€ PRACH Slotå…§é¸æ“‡å‚³é€çš„ PRACH çš„ç©ºé–“è¶Šå¤šï¼Œå¦‚æ­¤åœ¨å¤šå€‹ UE çš„æƒ…æ³ä¸‹ï¼ŒUE æ‰€æŒ‘é¸ä¹‹ **signature**ç™¼ç”Ÿç¢°æ’çš„æ©Ÿç‡è¶Šä½ã€‚è€Œæ­¤è¨­å®šçš„æ•¸é‡è¨˜ç‚º N_OCCã€‚
> 

æ™‚åŸŸä¸Šçš„ Preamble ä¸­æ®µç”± Preamble Sequence çµ„æˆï¼Œå…¶ä¸­ä¸€ Sequence çš„é•·åº¦è¨˜ç‚º
LRAï¼ŒLRA å€¼å¯ç‚º 839 æˆ– 139ï¼Œé•·åº¦ 839 ä¹‹åºåˆ—è¨˜ç‚ºé•·åºåˆ—ï¼ˆLong Preambleï¼‰

1. PRACH é…ç½®åƒæ•¸ï¼ˆPRACH Configuration Index, `prach_ConfigIndex`ï¼‰ã€
2. é‚è¼¯æ ¹æ•¸åˆ—ï¼ˆLogical Root Sequence Index, `rootSequenceIndex`ï¼‰ã€
3. `zeroCorrelationZoneConfig`ã€
4. å¯ç™¼é€ Preamble çš„æ™‚é–“é»

é€éé€™äº›åƒæ•¸ï¼ŒUE å¯ç”Ÿæˆ64 çµ„ Preamble Sequenceï¼Œ64 çµ„ Preamble Sequence çš†ç‚º Zadoffâ€“Chu åºåˆ—ï¼ˆZadoffâ€“ChuSequence, ZC Sequenceï¼‰ï¼Œè€Œ UE æœƒå¾ä¸­éš¨æ©Ÿæ“‡ä¸€å‚³é€ã€‚

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%202.png)

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%203.png)

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%204.png)

> UE å¯è—‰ç”± `prach_ConfigIndex` æŸ¥è¡¨å–å¾— Format é€²è€Œå¾—çŸ¥
`N_rep` èˆ‡ `L_RA`
> 

> [á¶™](https://zh.wikipedia.org/w/index.php?title=%E1%B6%99&action=edit&redlink=1)å€¼ç‚ºæ ¹åºåˆ—æ•¸ï¼ˆRoot Sequence Numberã€`rootSequenceNumber`ï¼‰ï¼Œå¯è—‰ç”±`rootSequenceIndex` æŸ¥è¡¨å–å¾—ã€‚å…¶é¤˜ Preamble Sequence å‰‡ä½¿ç”¨æ­¤ **Root Sequence** ä¸
æ–·åšå¾ªç’°ä½ç§»**ï¼ˆCyclic Shiftï¼‰**ç”Ÿæˆã€‚
> 

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%205.png)

> å¯ç”± **Root Sequence** ç”¢ç”Ÿå¤šçµ„ **Preamble Sequence**ï¼Œå¯¦éš›å¯ç”¢ç”Ÿçš„æ•¸é‡ç”±
**N_CS** æ§åˆ¶ã€‚N_CS å¯ç”± `zeroCorrelationZoneConfig` æŸ¥è¡¨å–å¾—ã€‚è‹¥ç”¢ç”Ÿçš„æ•¸é‡ä¸åŠ 64
çµ„ï¼Œå‰‡å¢åŠ  `rootSequenceIndex`ï¼ŒæŸ¥è¡¨å–å¾—æ–° `rootSequenceNumber` å†ç”Ÿæˆä¸€æ–° Root
Sequence åš Cyclic Shiftï¼Œç›´åˆ°ç”¢ç”Ÿ 64 çµ„ Preamble Sequence ç‚ºæ­¢
> 

> **Time domain to frequency**
> 
> 
> ![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%206.png)
> 
> æœ€å¾Œï¼Œå†å°‡ time domain çš„åºåˆ—å±•é–‹åˆ° frequency domainã€‚
> è‡³æ­¤ï¼ŒUE å°‡ç”Ÿæˆ 64 çµ„ Preamble Sequenceï¼ŒæŒ‰ç”Ÿæˆé †åºç·¨è™Ÿç‚º [0, 63]ï¼ŒUE å°‡æœƒéš¨
> æ©Ÿæ“‡ä¸€ä¸¦é‡è¤‡ `N_rep` æ¬¡å¾ŒåŠ ä¸Š Cyclic Prefix å‚³é€ï¼ŒUE æ‰€æŒ‘é¸çš„ Preamble Sequence ä¹‹ç·¨
> è™Ÿå³ç‚º signatureã€‚
> 

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%207.png)

<aside>

### Zadoff-Chu sequence **characteristic**

Preamble Sequence ç”± ZC Sequence çµ„æˆã€‚

å›  Zadoff-Chu Sequence å…·æœ‰**æŒ¯å¹…æ†å®š**ä¸”**åºåˆ—ç›¸é—œå‡½æ•¸ç‚ºé›¶**ï¼ˆConstant Amplitude
Zero Autocorrelation, CAZACï¼‰çš„ç‰¹æ€§ï¼Œå› æ­¤è¡ä¼¸å‡ºè¨±å¤šåœ¨è¨Šè™Ÿè™•ç†ä¸Šçš„å„ª
å‹¢ï¼Œ**é€²è€Œè¢«ä½¿ç”¨æ–¼ RACH ä¼°æ¸¬**ã€‚
å…· CAZAC ç‰¹æ€§ä¹‹åºåˆ—å°æ–¼ RACH ä¼°æ¸¬çš„æœ€å¤§å„ªå‹¢å³ç‚ºå¯é€é **Cyclic Shift** ç”¢ç”Ÿå¤š
çµ„å½¼æ­¤ç‚ºæ­£äº¤ï¼ˆ**Orthohonal**ï¼‰çš„åºåˆ—ï¼Œä¸”è‹¥å°‡ä¸€ç¶“é **N é»ç§»ä½å¾Œ**çš„ Sequence èˆ‡åŸæœ¬çš„
Sequence åšç›¸é—œå‡½æ•¸ï¼ˆ**Correlation**ï¼‰å¾Œï¼Œå…¶çµæœå°‡æ–¼**ç¬¬ N é»ä¸Šå‡ºç¾æœ€å¤§å€¼**ï¼Œå…¶é¤˜å€åŸŸå‰‡
ç‚ºé›¶ç›¸é—œå€ï¼ˆ**Zero Correlation Zone, ZCZ**ï¼‰ã€‚é€éæ­¤ç‰¹æ€§ï¼ŒRACH æµç¨‹ä¸Šä¸¦ä¸éœ€è¦é€
ä¸€æ¯”å°ä»¥æ‰¾å‡º signatureï¼Œ**åªéœ€è¦å°‡æ”¶åˆ°çš„è¨Šè™Ÿèˆ‡åŸå§‹ Root Sequence åš Correlation**ï¼Œå³
å¯æ‰¾åˆ°å°æ‡‰çš„ signatureã€‚ä¸”å› ç‚ºç§»ä½éå¾Œçš„åºåˆ—å½¼æ­¤ç‚ºæ­£äº¤(**Orthogonal**)ï¼Œæ•…å³ä½¿æœ‰å¤š UE æ–¼åŒæ™‚åŸŸèˆ‡åŒé »åŸŸå‚³é€ Preambleï¼Œåªè¦å…¶æ‰€æŒ‘é¸ä¹‹ signature ä¸åŒäº¦**ä¸æœƒå—å½¼æ­¤å¹²æ“¾**ã€‚

</aside>

### RACH signal process procedure

UE æœƒç™¼é€ä¸€æ®µç”±**ç³»çµ±åƒæ•¸**(SIB1)èˆ‡ **signature** æ‰€è¨ˆç®—çš„ **Preamble**ï¼Œä»¥ä¸‹å°‡
ä»‹ç´¹åŸºåœ°å°å¦‚ä½•é€éæ”¶åˆ°çš„è¨Šè™Ÿè§£å‡ºæ˜¯å¦æœ‰ UE ç™¼é€ Preambleï¼Œä¸¦æ­£ç¢ºæ‰¾å‡º UE æ‰€é¸æ“‡
çš„ **signature**ã€‚

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%208.png)

[https://drive.google.com/file/d/1epnjxR2YKsmGwDnT3gXcDMIl2_D8vQgP/view?usp=sharing](https://drive.google.com/file/d/1epnjxR2YKsmGwDnT3gXcDMIl2_D8vQgP/view?usp=sharing)

![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%209.png)

1. **ç§»é™¤ Cyclic Prefix**
    1. åŸºåœ°å°æ”¶åˆ°çš„è¨Šè™Ÿæ ¼å¼å°±å¦‚PRACH formatæ‰€ç¤ºç‚ºä¸€å®Œæ•´çš„ Preambleï¼Œå› æ­¤æµç¨‹ç¬¬ä¸€æ­¥å³ç‚º
    ç§»é™¤ **Cyclic Prefix**ï¼ˆCP Removalï¼‰ï¼Œåƒ…ç•™ä¸‹ä¸­é–“å¾ŒçºŒéœ€è¦ä¼°æ¸¬çš„ **Preamble Sequence** éƒ¨åˆ†ã€‚
2. **å¿«é€Ÿå‚…ç«‹è‘‰è½‰æ›**
    1. å°‡æ”¶åˆ°çš„è¨Šè™Ÿä½¿ç”¨å¿«é€Ÿå‚…ç«‹è‘‰è½‰æ›ï¼ˆFast Fourier Transform, **FFT**ï¼‰ï¼Œå°‡è¨Šè™Ÿ
    è‡ª **time domain è½‰æ›è‡³ frequency domain**ã€‚
        
        ![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%2010.png)
        
3. **Correlation**
    1. RACH æµç¨‹ä¸»è¦ç›®çš„å³ç‚ºæ‰¾å‡ºæ­¤æ®µæ¥æ”¶åˆ°ä¹‹è¨Šè™Ÿæ˜¯å¦å«æœ‰ UE ç™¼é€çš„ Preambleï¼Œä¸”
    å…¶æ‰€é¸ç”¨ä¹‹ **signature** ç‚ºä½•ã€‚é€éç« ç¯€2.2é—œæ–¼ ZC Sequence ç‰¹æ€§ä¹‹èªªæ˜ï¼Œåªè¦å°‡æ”¶åˆ°
    çš„è¨Šè™Ÿèˆ‡ **Root Sequence** åš **Correlation** å³å¯åˆ¤æ–·æ­¤è¨Šè™Ÿæ˜¯å¦è‡ªæ­¤ **Root Sequence** åš **Cyclic Shift** ç”¢å‡ºèˆ‡å…¶ **Cv** å€¼ç‚ºä½•ã€‚è€Œ **Root Sequence** å¯æ–¼åŸºåœ°å°å•Ÿå‹•åˆå§‹åŒ–æ™‚å…ˆè¡Œè¨ˆç®—ï¼Œå¾ŒçºŒåœ¨ä¼°æ¸¬æ™‚ï¼Œåƒ…éœ€å¸¶å…¥ **Correlation** è¨ˆç®—ã€‚å…¶ä¸­ F(n)â€˜ ç‚ºF(n) ä¹‹å…±è»›è¤‡æ•¸ã€‚F(n) is signal in Frequency domain
        
        ![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%2011.png)
        
4. **åå‘å¿«é€Ÿå‚…ç«‹è‘‰è½‰æ›**
    1. å°‡ **Correlation** çš„çµæœä½¿ç”¨**åå‘å¿«é€Ÿå‚…ç«‹è‘‰è½‰æ›**ï¼ˆInverse Fast Fourier Transform, **IFFT**
    ï¼‰è‡ª **frequency domain è½‰å› time domain**ã€‚
        
        ![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%2012.png)
        
5. **è¨Šè™Ÿç–Šåˆ**
    1. åœ¨æ­¤å°‡ä»£è¡¨ç›¸åŒè³‡è¨Šçš„è³‡æ–™åŠ ç¸½å¹³å‡ï¼Œå³å…ˆå–**æ‰€æœ‰è¼¸å…¥è¨Šè™Ÿçš„åŠŸç‡**ï¼ˆpowerï¼‰ï¼Œå†
    **å°‡ä¸€æ”¯å¤©ç·šå…§æ”¶åˆ°æ‰€æœ‰é‡è¤‡çš„è¨Šè™ŸåŠ ç¸½å¹³å‡**ï¼Œæœ€å¾Œå†å°‡æ‰€æœ‰å¤©ç·šçš„è¨Šè™ŸåŠ ç¸½å¹³å‡
        
        ![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%2013.png)
        
6. **å‰å°ç¢¼ä¼°æ¸¬**
    1. æœ€å¾Œåˆ¤æ–·æ­¤æ¬¡æ¥æ”¶è¨Šè™Ÿä¸­æ˜¯å¦æœ‰ UE å‚³é€ **Preamble** åŠåˆ¤å®šè©² UE æ‰€é¸æ“‡ä¹‹ **signature**
    ç‚ºä½•ã€‚æ–¹æ³•å³ç‚ºå°‡å‰é …è¼¸å‡ºä¹‹çµæœèˆ‡äº‹å…ˆè¨ˆç®—ä¹‹**è‡¨ç•Œé»**ï¼ˆ**threshold**ï¼‰åšæ¯”è¼ƒï¼Œè‹¥åŠŸç‡
    è¶…é threshold å³è¦–ç‚ºæœ‰ UE å˜—è©¦å‚³é€è©² **Preamble Sequence**ã€‚æ¥ä¸‹ä¾†å†çœ‹è©²å°–å³°ï¼ˆpeakï¼‰å‡ºç¾åœ¨å“ªä¸€æ®µæ™‚é–“å€é–“ï¼ˆWindowï¼‰ï¼ŒWindow é•·åº¦å®šç¾©å¦‚ï¼Œæ ¹æ“šç« ç¯€2.2.2ï¼Œå€‹
    åˆ¥ Window å³å°æ‡‰è‡³ Cvï¼Œé€²è€Œå¯æ±‚å°æ‡‰ä¹‹ signatureã€‚
        
        ![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%2014.png)
        
        ![image.png](Review%20RACH%20thesis%20131100983143805cbd46f3b0255919e9/image%2015.png)
        
        é™¤äº†éœ€è¦åµæ¸¬æ˜¯å¦æœ‰ UE å‚³é€ Preamble å¤–ï¼ŒPRACH äº¦æœ‰ UE èˆ‡ gNB åŒæ­¥ä¹‹åŠŸèƒ½ã€‚
        ç”±æ–¼å¯¦éš›çš„å‚³è¼¸ç’°å¢ƒç›¸ç•¶è¤‡é›œï¼Œä½¿å¾— gNB åœ¨æ”¶åˆ° UE çš„è¨Šæ¯å¯èƒ½æœƒç¶“é**å¤šç¨®è·¯å¾‘åå°„**
        å†ç”± gNB æ¥æ”¶åˆ°ä¸¦è™•ç†ï¼Œç”±æ–¼æ­¤ç¨®ç„¡ç·šè¨Šè™Ÿç‰¹æ€§ä½¿ UE å‚³é€è¨Šè™Ÿçš„æ™‚é–“é»å¯èƒ½ä¸æœƒå°
        ä¸Š gNB å¯¦éš›æ¥æ”¶åˆ°è¨Šè™Ÿçš„æ™‚é–“é»ã€‚åœ¨å‰æ®µæ‰¾å‡º peak ä¹‹å¾Œï¼Œé™¤äº†å¯å¾—å…¶æ‰€å°æ‡‰ä¹‹ Cv å€¼
        å¤–ï¼Œäº¦å¯è—‰ç”±è©² peak å‡ºç¾ä½ç½®èˆ‡å…¶é æœŸä½ç½®ç›¸å·®å¤šå°‘å¾— **TA**å€¼ï¼Œæ­¤å€¼å°‡æ–¼å¾ŒçºŒ gNB
        ç™¼é€ PRACH Response æ™‚å‚³é€çµ¦ UEï¼ŒUE å¯è—‰æ­¤èª¿æ•´ç™¼é€è¨Šè™Ÿä¹‹æ™‚æ©Ÿä»¥é”åˆ°åŒæ­¥ä¹‹ç›®
        çš„ã€‚
        

## Implement in OAI UE

<aside>
ğŸ’¡

Check this log 

```c
void compute_nr_prach_seq(uint8_t short_sequence, uint8_t num_sequences, uint8_t rootSequenceIndex, c16_t X_u[64][839])
{
  ...
    LOG_D(PHY,"compute_prach_seq: prach short sequence %x, num_sequences %d, rootSequenceIndex %d\n", short_sequence, num_sequences, rootSequenceIndex);

```

compute_prach_seq: prach short sequence 1, num_sequences 16, rootSequenceIndex 1

</aside>

## Implement in OAI gNB

```c
void rx_nr_prach(PHY_VARS_gNB *gNB,
                 nfapi_nr_prach_pdu_t *prach_pdu,
                 int prachOccasion,
                 int frame,
                 int slot,
                 uint16_t *max_preamble,
                 uint16_t *max_preamble_energy,
                 uint16_t *max_preamble_delay)
{ 
```

 `rx_nr_prach` ç”¨æ–¼è™•ç† 5G NR (New Radio) ä¸­çš„ PRACH (Physical Random Access Channel) æ¥æ”¶ã€‚æˆ‘å°‡åˆ†æ®µè§£é‡‹é€™å€‹å‡½æ•¸çš„ä¸»è¦éƒ¨åˆ†ï¼š

1. å‡½æ•¸åƒæ•¸å’Œåˆå§‹åŒ–ï¼š
- å‡½æ•¸æ¥æ”¶å¤šå€‹åƒæ•¸ï¼ŒåŒ…æ‹¬ gNB çµæ§‹ã€PRACH PDUã€å¹€è™Ÿã€æ™‚éš™ç­‰
- åˆå§‹åŒ–å¤šå€‹è®Šæ•¸ï¼Œå¦‚ rootSequenceIndexã€NCSã€prach_sequence_length ç­‰
1. PRACH é…ç½®è¨­ç½®ï¼š
- å¾ gNB é…ç½®ä¸­ç²å– PRACH ç›¸é—œåƒæ•¸
- è¨­ç½® PRACH æ ¼å¼ã€Zadoff-Chu åºåˆ—é•·åº¦ (N_ZC) ç­‰
1. ä¸»è¦è™•ç†å¾ªç’°ï¼š
- å°æ¯å€‹å‰å°ç¢¼ç´¢å¼•ï¼ˆ0-63ï¼‰é€²è¡Œå¾ªç’°
- æ ¹æ“š restricted_set åƒæ•¸æ±ºå®šè™•ç†æ–¹å¼ï¼ˆéå—é™é›†æˆ–é«˜é€Ÿæƒ…æ³ï¼‰
1. DFT è¨ˆç®—ï¼š
- å°æ¥æ”¶åˆ°çš„ä¿¡è™Ÿé€²è¡Œé›¢æ•£å‚…ç«‹è‘‰è®Šæ› (DFT)
- å°æ¯å€‹æ¥æ”¶å¤©ç·šé€²è¡Œè™•ç†
1. èƒ½é‡æª¢æ¸¬ï¼š
- è¨ˆç®—æ¯å€‹æ™‚é–“åç§»çš„èƒ½é‡
- è¨˜éŒ„æœ€å¤§èƒ½é‡ã€å°æ‡‰çš„å‰å°ç¢¼ç´¢å¼•å’Œå»¶é²
1. TAï¼ˆTiming Advanceï¼‰å€¼è¨ˆç®—ï¼š
- æ ¹æ“šä¸åŒçš„ PRACH æ ¼å¼å’Œé…ç½®è¨ˆç®— TA å€¼
1. æ—¥èªŒè¨˜éŒ„ï¼š
- å¦‚æœå•Ÿç”¨äº†èª¿è©¦æ¨™èªŒï¼Œè¨˜éŒ„å„ç¨®ä¸­é–“çµæœå’Œè¨ˆç®—å€¼

é€™å€‹å‡½æ•¸çš„ä¸»è¦ç›®çš„æ˜¯æª¢æ¸¬æ¥æ”¶åˆ°çš„ PRACH ä¿¡è™Ÿï¼Œæ‰¾å‡ºæœ€å¼·çš„å‰å°ç¢¼ï¼Œä¸¦è¨ˆç®—ç›¸æ‡‰çš„æ™‚é–“æå‰å€¼ã€‚é€™äº›ä¿¡æ¯å°æ–¼å»ºç«‹åˆå§‹ä¸Šè¡Œéˆè·¯åŒæ­¥å’Œå¾ŒçºŒçš„éš¨æ©Ÿæ¥å…¥éç¨‹éå¸¸é‡è¦ã€‚

é€™å€‹ `rx_nr_prach` å‡½æ•¸æ˜¯ç”¨æ–¼è™•ç† 5G NR çš„ PRACHï¼ˆç‰©ç†éš¨æ©Ÿå­˜å–ä¿¡é“ï¼‰æ¥æ”¶çš„å¯¦ç¾ï¼Œç›®çš„æ˜¯åœ¨ PRACH æ¥æ”¶éç¨‹ä¸­è§£ç¢¼å‰å°ç¢¼ï¼Œä¸¦ç²å¾—æœ€å¤§èƒ½é‡çš„å‰å°ç¢¼ç´¢å¼•ã€å»¶é²å’Œèƒ½é‡å€¼ã€‚ä»¥ä¸‹æ˜¯å‡½æ•¸çš„è©³ç´°åˆ†æ®µè§£é‡‹ï¼š

---

### **å‡½æ•¸åƒæ•¸**

1. **`PHY_VARS_gNB *gNB`**åŸºç«™çš„ç‰©ç†å±¤æ•¸æ“šçµæ§‹ï¼ŒåŒ…å«æ‰€æœ‰åŸºç«™ç›¸é—œçš„åƒæ•¸å’Œç·©å­˜ã€‚
2. **`uint16_t *max_preamble`**ç”¨æ–¼è¿”å›æœ€å¤§èƒ½é‡å°æ‡‰çš„å‰å°ç¢¼ç´¢å¼•ã€‚
3. **`uint16_t *max_preamble_energy`**ç”¨æ–¼è¿”å›æœ€å¤§èƒ½é‡å€¼ã€‚
4. **`uint16_t *max_preamble_delay`**ç”¨æ–¼è¿”å›æœ€å¤§èƒ½é‡å°æ‡‰çš„å»¶é²å€¼ã€‚

---

### **åˆå§‹åŒ–å’Œæª¢æŸ¥**

1. **æª¢æŸ¥è¼¸å…¥åƒæ•¸æœ‰æ•ˆæ€§**
    
    ```c
    
    AssertFatal(gNB != NULL, "Can only be called from gNB\n");
    ```
    
    ç¢ºä¿ `gNB` ä¸ç‚ºç©ºï¼Œå¦å‰‡å ±éŒ¯ã€‚
    
2. **æå– PRACH é…ç½®**
    
    ```c
    nfapi_nr_prach_config_t *cfg = &gNB->gNB_config.prach_config;
    NR_DL_FRAME_PARMS *fp;
    ```
    
    `cfg` å’Œ `fp` åˆ†åˆ¥å­˜å„² PRACH é…ç½®å’Œä¸‹è¡Œå¹€åƒæ•¸ã€‚
    
3. **æå–åŸºæœ¬åƒæ•¸**
    - `nb_rx`: åŸºç«™æ¥æ”¶å¤©ç·šæ•¸é‡ã€‚
    - `rootSequenceIndex`: æ ¹åºåˆ—ç´¢å¼•ã€‚
    - `NCS`: é›¶ç›¸é—œå€é–“ï¼ˆé›¶ç›¸é—œå€å¤§å°ï¼‰ã€‚zero correlation

### **å‰å°ç¢¼è™•ç†ä¸»è¦é‚è¼¯**

### **1. åˆå§‹åŒ–éƒ¨åˆ†**

- åˆå§‹åŒ–é›¶ç›¸é—œå€é–“çš„è¨ˆç®—å’Œ oversampling èª¿æ•´ã€‚
    
    ```c
    NCS2 = (N_ZC == 839) ? ((NCS << 10) / 839) : ((NCS << 8) / 139);
    if (NCS2 == 0) NCS2 = N_ZC;
    ```
    

### **2. éæ­·æ‰€æœ‰å¯èƒ½çš„å‰å°ç¢¼ç´¢å¼•**

```c

for (preamble_index = 0; preamble_index < 64; preamble_index++) {
```

é€™è£¡å˜—è©¦ 64 å€‹å¯èƒ½çš„å‰å°ç¢¼ï¼Œé‡å°æ¯å€‹å‰å°ç¢¼è¨ˆç®—èƒ½é‡ä¸¦æ‰¾å‡ºæœ€å¤§å€¼ã€‚

### **è™•ç†æ­¥é©Ÿç´°ç¯€**

### **2.1 ç¢ºå®šå‰å°ç¢¼åç§»**

- **é™åˆ¶é›†æ¨¡å¼ï¼š**
    
    ```c
    
    preamble_offset = ((NCS == 0) ? preamble_index : (preamble_index / (N_ZC / NCS)));
    ```
    
- **é«˜é€Ÿæ¨¡å¼ï¼š**
éœ€è¦é¡å¤–è€ƒæ…®æ ¹åºåˆ—ç´¢å¼•çš„å¾ªç’°ä½ç§»ï¼š
    
    ```c
    
    while (not_found == 1) {
        ...
    }
    ```
    

### **2.2 DFT è¨ˆç®—**

```c
if (new_dft == 1) {
    Xu = (int16_t*)gNB->X_u[preamble_offset-first_nonzero_root_idx];
    memset(prach_ifft, 0, ((N_ZC == 839) ? 2048 : 256) * sizeof(int32_t));
}

```

é‡å°ç•¶å‰çš„æ ¹åºåˆ—é€²è¡Œ DFT å’Œå¾ŒçºŒè™•ç†ã€‚

---

### **2.3 ä¿¡è™Ÿèƒ½é‡è¨ˆç®—**

1. è¨ˆç®— IFFT å¾Œçš„èƒ½é‡ã€‚
    
    ```c
    
    for (int i = 0; i < 1024; i++) {
        prach_ifft[i] += (int32_t)prach_ifft_tmp[i<<1] * (int32_t)prach_ifft_tmp[i<<1];
    }
    
    ```
    
2. åˆ¤æ–·æœ€å¤§èƒ½é‡å‰å°ç¢¼ã€‚
    
    ```c
    
    if (levdB > *max_preamble_energy) {
        *max_preamble_energy = levdB;
        *max_preamble_delay = i;
        *max_preamble = preamble_index;
    }
    
    ```